name: Test & Publish Crates

on:
  workflow_call:
    secrets:
      tokens:
        description: A newline-separated list of 'registry=token' pairs for authenticating with Cargo registries.
        required: false
    inputs:
      publish:
        description: A value indicating whether to publish the packages.
        type: boolean
        required: false
        default: true
      publish_registry:
        description: The alias of the Cargo registry where crates will be published, as specified in .cargo/config.toml. Newline separated for multiple registries.
        type: string
        required: false
        default: |
          "crates-io" # Default to the public registry

env:
  CARGO_TERM_COLOR: always
  CARGO_RELEASE_VERSION: 0.25.10
  COMMIT_USER: github-actions
  COMMIT_EMAIL: github-actions@users.noreply.github.com

jobs:
  prep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Pre-warm cache
      - name: Install cargo-release
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-release
          version: ${{ env.CARGO_RELEASE_VERSION }}

  test:
    runs-on: ubuntu-latest
    needs: [prep]
    steps:
      - uses: actions/checkout@v4

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: debug # Hardcoded to debug because that is what cargo clippy/test use.

      - name: Cargo Registry Login
        uses: p6m-dev/github-actions/cargo-registry-login@main
        with:
          cargo-tokens: ${{ secrets.tokens }}

      - name: Lint
        if: always()
        id: lint
        run: cargo clippy --all-targets --all-features 2>&1

      - name: Test Crates
        if: always()
        id: test
        run: cargo test 2>&1

      - name: Output Summary
        if: always()
        run: |
          echo '## Clippy Results' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.lint.outputs.stdout }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo '## Test Results' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.test.outputs.stdout }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Bump versions to unblock SDLC as soon as possible
  bump-version:
    runs-on: ubuntu-latest
    needs: [prep]
    if: ${{ inputs.publish }}

    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-release
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-release
          version: ${{ env.CARGO_RELEASE_VERSION }}

      - name: Prepare next Cargo beta
        run: |
          git config user.name ${{ env.COMMIT_USER }}
          git config user.email ${{ env.COMMIT_EMAIL }}
          cargo release tag --no-confirm --execute
          cargo release version --no-confirm --execute beta
          cargo release commit --no-confirm --execute

      - name: Push
        run: |
          git push
          git push --tags

  publish-crates:
    if: ${{ inputs.publish }}
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-workspaces
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-workspaces
          version: 0.4.0

      - name: Publish Crates to Registries
        run: |
          # Parse registries from input (newline separated)
          echo "${{ inputs.publish_registry }}" | while IFS= read -r registry; do
            # Skip empty lines
            if [ -z "$registry" ]; then
              continue
            fi
            
            # Remove quotes from registry name
            registry=$(echo "$registry" | sed 's/^"//;s/"$//')
            
            echo "Publishing to registry: $registry"
            
            # Extract the appropriate token for this registry from secrets
            if [ -z "${{ secrets.tokens }}" ]; then
              echo "ERROR: No tokens provided in secrets.tokens"
              exit 1
            fi
            
            token=$(echo "${{ secrets.tokens }}" | grep "^${registry}=" | cut -d'=' -f2-)
            
            if [ -z "$token" ]; then
              echo "ERROR: No token found for registry: $registry"
              exit 1
            fi
            
            echo "Publishing to registry: $registry"
            cargo workspaces publish --publish-as-is --registry "$registry" --no-verify --token "Bearer $token"
          done

      - name: Update Job Summary
        env:
          # The summary template needs to be quoted twice. The `|-` for YAML and the `"`s for `jq`.
          # Package metadata fields can be referenced using `\(.field_name)`.
          # Run `cargo metadata --format-version 1 --no-deps | jq -r '.packages[0]'` in the repo root to see what metadata fields are available.
          PACKAGE_SUMMARY_TEMPLATE: |-
            "## \(.name)

            **Version:** \(.version)
            **Description:** \(.description)
            "
        run: |
          # Always print out versions for ALL workspace packages since they may differ.
          PACKAGES_METADATA=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages')
          echo "$PACKAGES_METADATA" | jq -r '.[] |'"$PACKAGE_SUMMARY_TEMPLATE" | tee -a $GITHUB_STEP_SUMMARY
